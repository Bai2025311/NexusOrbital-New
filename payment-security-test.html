<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付安全与分析测试 - NexusOrbital</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .result-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">NexusOrbital</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="membership.html">会员</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="payment.html">支付</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="refund.html">退款</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="payment-analytics.html">支付分析</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <span id="currentUser">用户</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="profile.html">个人资料</a></li>
                            <li><a class="dropdown-item" href="orders.html">我的订单</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container mt-4">
        <h2 class="mb-4">支付安全与分析测试</h2>
        
        <div class="row">
            <!-- 支付安全测试 -->
            <div class="col-md-6">
                <div class="card test-card">
                    <div class="card-header">
                        风险评估测试
                    </div>
                    <div class="card-body">
                        <form id="riskAssessmentForm">
                            <div class="mb-3">
                                <label for="amount" class="form-label">交易金额</label>
                                <input type="number" class="form-control" id="amount" value="1000">
                            </div>
                            <div class="mb-3">
                                <label for="paymentMethod" class="form-label">支付方式</label>
                                <select class="form-select" id="paymentMethod">
                                    <option value="wechat">微信支付</option>
                                    <option value="alipay">支付宝</option>
                                    <option value="stripe">Stripe</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="membershipId" class="form-label">会员类型</label>
                                <select class="form-select" id="membershipId">
                                    <option value="basic">基础会员</option>
                                    <option value="standard">标准会员</option>
                                    <option value="premium">高级会员</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="ip" class="form-label">IP地址</label>
                                <input type="text" class="form-control" id="ip" value="127.0.0.1">
                            </div>
                            <button type="submit" class="btn btn-primary">测试风险评估</button>
                        </form>
                        <div class="result-container mt-3">
                            <pre id="riskAssessmentResult">结果将显示在这里...</pre>
                        </div>
                    </div>
                </div>
                
                <div class="card test-card">
                    <div class="card-header">
                        数据加密测试
                    </div>
                    <div class="card-body">
                        <form id="encryptionForm">
                            <div class="mb-3">
                                <label for="dataToEncrypt" class="form-label">要加密的数据</label>
                                <input type="text" class="form-control" id="dataToEncrypt" value="敏感数据示例">
                            </div>
                            <div class="mb-3">
                                <label for="encryptionPurpose" class="form-label">加密目的</label>
                                <select class="form-select" id="encryptionPurpose">
                                    <option value="general">通用</option>
                                    <option value="payment">支付</option>
                                    <option value="user">用户</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">测试加密</button>
                        </form>
                        <div class="result-container mt-3">
                            <pre id="encryptionResult">结果将显示在这里...</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 支付分析测试 -->
            <div class="col-md-6">
                <div class="card test-card">
                    <div class="card-header">
                        支付分析概览测试
                    </div>
                    <div class="card-body">
                        <form id="analyticsOverviewForm">
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="forceUpdate">
                                <label class="form-check-label" for="forceUpdate">强制更新数据</label>
                            </div>
                            <button type="submit" class="btn btn-primary">获取分析概览</button>
                        </form>
                        <div class="result-container mt-3">
                            <pre id="analyticsOverviewResult">结果将显示在这里...</pre>
                        </div>
                    </div>
                </div>
                
                <div class="card test-card">
                    <div class="card-header">
                        交易趋势测试
                    </div>
                    <div class="card-body">
                        <form id="trendAnalyticsForm">
                            <div class="mb-3">
                                <label for="trendType" class="form-label">趋势类型</label>
                                <select class="form-select" id="trendType">
                                    <option value="daily">每日趋势</option>
                                    <option value="weekly">每周趋势</option>
                                    <option value="monthly">每月趋势</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="trendDays" class="form-label">天数</label>
                                <select class="form-select" id="trendDays">
                                    <option value="30">30天</option>
                                    <option value="90">90天</option>
                                    <option value="180">180天</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">获取趋势数据</button>
                        </form>
                        <div class="result-container mt-3">
                            <pre id="trendAnalyticsResult">结果将显示在这里...</pre>
                        </div>
                    </div>
                </div>
                
                <div class="card test-card">
                    <div class="card-header">
                        退款分析测试
                    </div>
                    <div class="card-body">
                        <form id="refundAnalyticsForm">
                            <div class="mb-3">
                                <label for="refundDays" class="form-label">天数</label>
                                <select class="form-select" id="refundDays">
                                    <option value="30">30天</option>
                                    <option value="90">90天</option>
                                    <option value="180">180天</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">获取退款分析</button>
                        </form>
                        <div class="result-container mt-3">
                            <pre id="refundAnalyticsResult">结果将显示在这里...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2025 NexusOrbital. 保留所有权利。</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // 模拟认证令牌
        if (!localStorage.getItem('token')) {
            localStorage.setItem('token', 'test_token_' + Date.now());
            localStorage.setItem('user', JSON.stringify({
                id: 'user_001',
                name: '测试用户',
                email: 'test@example.com',
                isAdmin: true
            }));
        }
        
        // 显示当前用户
        document.getElementById('currentUser').textContent = 
            JSON.parse(localStorage.getItem('user')).name || '用户';
        
        // 获取认证令牌
        function getToken() {
            return localStorage.getItem('token');
        }
        
        // 格式化JSON
        function formatJSON(json) {
            return JSON.stringify(json, null, 2);
        }
        
        // 风险评估测试
        document.getElementById('riskAssessmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultElement = document.getElementById('riskAssessmentResult');
            resultElement.textContent = '正在请求...';
            
            try {
                const amount = document.getElementById('amount').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const membershipId = document.getElementById('membershipId').value;
                const ip = document.getElementById('ip').value;
                
                // 构建请求数据
                const requestData = {
                    amount,
                    paymentMethod,
                    membershipId,
                    description: '风险评估测试'
                };
                
                // 发送请求
                const response = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json',
                        'X-Forwarded-For': ip // 模拟IP
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                resultElement.textContent = formatJSON(result);
            } catch (error) {
                resultElement.textContent = `请求失败: ${error.message}`;
            }
        });
        
        // 数据加密测试
        document.getElementById('encryptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultElement = document.getElementById('encryptionResult');
            resultElement.textContent = '正在请求...';
            
            try {
                const dataToEncrypt = document.getElementById('dataToEncrypt').value;
                const purpose = document.getElementById('encryptionPurpose').value;
                
                // 构建请求数据
                const requestData = {
                    data: dataToEncrypt,
                    purpose
                };
                
                // 发送请求
                const response = await fetch('/api/security/encrypt', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                resultElement.textContent = formatJSON(result);
            } catch (error) {
                resultElement.textContent = `请求失败: ${error.message}`;
            }
        });
        
        // 支付分析概览测试
        document.getElementById('analyticsOverviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultElement = document.getElementById('analyticsOverviewResult');
            resultElement.textContent = '正在请求...';
            
            try {
                const forceUpdate = document.getElementById('forceUpdate').checked;
                
                // 发送请求
                const response = await fetch(`/api/payment-analytics/overview?force=${forceUpdate}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                resultElement.textContent = formatJSON(result);
            } catch (error) {
                resultElement.textContent = `请求失败: ${error.message}`;
            }
        });
        
        // 交易趋势测试
        document.getElementById('trendAnalyticsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultElement = document.getElementById('trendAnalyticsResult');
            resultElement.textContent = '正在请求...';
            
            try {
                const trendType = document.getElementById('trendType').value;
                const trendDays = document.getElementById('trendDays').value;
                
                let endpoint;
                switch (trendType) {
                    case 'daily':
                        endpoint = `/api/payment-analytics/daily?days=${trendDays}`;
                        break;
                    case 'weekly':
                        endpoint = `/api/payment-analytics/weekly?weeks=${Math.ceil(trendDays / 7)}`;
                        break;
                    case 'monthly':
                        endpoint = `/api/payment-analytics/monthly?months=${Math.ceil(trendDays / 30)}`;
                        break;
                    default:
                        endpoint = `/api/payment-analytics/daily?days=${trendDays}`;
                }
                
                // 发送请求
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                resultElement.textContent = formatJSON(result);
            } catch (error) {
                resultElement.textContent = `请求失败: ${error.message}`;
            }
        });
        
        // 退款分析测试
        document.getElementById('refundAnalyticsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultElement = document.getElementById('refundAnalyticsResult');
            resultElement.textContent = '正在请求...';
            
            try {
                const refundDays = document.getElementById('refundDays').value;
                
                // 发送请求
                const response = await fetch(`/api/payment-analytics/refunds?days=${refundDays}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                resultElement.textContent = formatJSON(result);
            } catch (error) {
                resultElement.textContent = `请求失败: ${error.message}`;
            }
        });
        
        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>
